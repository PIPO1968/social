{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/social/src/utils/jwt.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\r\n\r\nexport function signToken(payload: any): string {\r\n    return jwt.sign(payload, JWT_SECRET, { expiresIn: '7d' });\r\n}\r\n\r\nexport function verifyToken(token: string): any {\r\n    try {\r\n        return jwt.verify(token, JWT_SECRET);\r\n    } catch (error) {\r\n        return null;\r\n    }\r\n}"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAEtC,SAAS,UAAU,OAAY;IAClC,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAK;AAC3D;AAEO,SAAS,YAAY,KAAa;IACrC,IAAI;QACA,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC7B,EAAE,OAAO,OAAO;QACZ,OAAO;IACX;AACJ","debugId":null}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/social/src/app/api/premium/torneos/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { verifyToken } from '@/utils/jwt';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const token = request.cookies.get('auth-token')?.value;\r\n        if (!token) {\r\n            return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\r\n        }\r\n\r\n        const decoded = verifyToken(token);\r\n        if (!decoded) {\r\n            return NextResponse.json({ error: 'Token inválido' }, { status: 401 });\r\n        }\r\n\r\n        const torneoData = await prisma.torneoPremium.findUnique({\r\n            where: { userId: decoded.userId }\r\n        });\r\n        // Forzar que el campo torneos sea string\r\n        if (torneoData && torneoData.torneos && typeof torneoData.torneos !== 'string') {\r\n            torneoData.torneos = JSON.stringify(torneoData.torneos);\r\n        }\r\n        return NextResponse.json(torneoData || {});\r\n    } catch (error) {\r\n        console.error('Error obteniendo torneos premium:', error);\r\n        return NextResponse.json({ error: 'Error interno del servidor' }, { status: 500 });\r\n    } finally {\r\n        await prisma.$disconnect();\r\n    }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const token = request.cookies.get('auth-token')?.value;\r\n        if (!token) {\r\n            return NextResponse.json({ error: 'No autenticado' }, { status: 401 });\r\n        }\r\n\r\n        const decoded = verifyToken(token);\r\n        if (!decoded) {\r\n            return NextResponse.json({ error: 'Token inválido' }, { status: 401 });\r\n        }\r\n\r\n        let torneosSanitizados = torneos;\r\n        if (typeof torneosSanitizados === 'string') {\r\n            try {\r\n                torneosSanitizados = JSON.parse(torneosSanitizados);\r\n            } catch {\r\n                torneosSanitizados = [];\r\n            }\r\n        }\r\n        // Para cada torneo, filtrar resultados duplicados por nick normalizado\r\n        const normalizar = (str: string) => (str || '').toLowerCase().replace(/\\s+/g, '');\r\n        torneosSanitizados = torneosSanitizados.map((torneo: any) => {\r\n            if (torneo.resultados && Array.isArray(torneo.resultados)) {\r\n                const mejoresPorUsuario: { [nick: string]: any } = {};\r\n                torneo.resultados.forEach((r: any) => {\r\n                    const nickNorm = normalizar(r.nick);\r\n                    if (!mejoresPorUsuario[nickNorm] || r.puntuacion > mejoresPorUsuario[nickNorm].puntuacion) {\r\n                        mejoresPorUsuario[nickNorm] = r;\r\n                    }\r\n                });\r\n                torneo.resultados = Object.values(mejoresPorUsuario);\r\n            }\r\n            return torneo;\r\n        });\r\n        let torneosString = JSON.stringify(torneosSanitizados);\r\n\r\n        const torneoData = await prisma.torneoPremium?.upsert({\r\n            where: { userId: decoded.userId },\r\n            update: {\r\n                torneos: torneosString ?? undefined,\r\n                lastReset: lastReset ? new Date(lastReset) : undefined,\r\n                torneoActivo: torneoActivo ?? undefined\r\n            },\r\n            create: {\r\n                userId: decoded.userId,\r\n                torneos: torneosString ?? '[]',\r\n                lastReset: lastReset ? new Date(lastReset) : undefined,\r\n                torneoActivo: torneoActivo ?? null\r\n            }\r\n        });\r\n\r\n        return NextResponse.json(torneoData);\r\n    } catch (error) {\r\n        console.error('Error guardando torneos premium:', error);\r\n        return NextResponse.json({ error: 'Error interno del servidor' }, { status: 500 });\r\n    } finally {\r\n        await prisma.$disconnect();\r\n    }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}