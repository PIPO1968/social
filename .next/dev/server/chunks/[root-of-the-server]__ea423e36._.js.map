{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/social/src/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const nick = searchParams.get('nick');\r\n\r\n        if (!nick) {\r\n            return NextResponse.json({ error: 'Nick required' }, { status: 400 });\r\n        }\r\n\r\n        const user = await prisma.user.findUnique({ where: { nick } });\r\n        if (!user) {\r\n            return NextResponse.json({ error: 'User not found' }, { status: 404 });\r\n        }\r\n\r\n        const chats = await prisma.chat.findMany({\r\n            where: { userId: user.id },\r\n            orderBy: { createdAt: 'desc' },\r\n            take: 5\r\n        });\r\n\r\n        const messages = chats.map(c => {\r\n            const parts = c.mensaje.split(': ');\r\n            const direction = parts[0];\r\n            const text = parts.slice(1).join(': ');\r\n            let from, to;\r\n            if (direction.startsWith('To ')) {\r\n                from = user.nick;\r\n                to = direction.replace('To ', '');\r\n            } else if (direction.startsWith('From ')) {\r\n                to = user.nick;\r\n                from = direction.replace('From ', '');\r\n            }\r\n            // Usar ISO string para evitar problemas de parseo en frontend\r\n            return { from, to, text, fecha: c.createdAt.toISOString() };\r\n        });\r\n\r\n        return NextResponse.json(messages);\r\n    } catch (error) {\r\n        console.error('Error fetching chat:', error);\r\n        return NextResponse.json({ error: 'Error fetching chat' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const body = await request.json();\r\n        const { from, to, text } = body;\r\n\r\n        const fromUser = await prisma.user.findUnique({ where: { nick: from } });\r\n        if (!fromUser) {\r\n            return NextResponse.json({ error: 'From user not found' }, { status: 404 });\r\n        }\r\n\r\n        const toUser = await prisma.user.findUnique({ where: { nick: to } });\r\n        if (!toUser) {\r\n            return NextResponse.json({ error: 'To user not found' }, { status: 404 });\r\n        }\r\n\r\n        const message = `To ${to}: ${text}`;\r\n        await prisma.chat.create({\r\n            data: {\r\n                userId: fromUser.id,\r\n                mensaje: message\r\n            }\r\n        });\r\n\r\n        const messageTo = `From ${from}: ${text}`;\r\n        await prisma.chat.create({\r\n            data: {\r\n                userId: toUser.id,\r\n                mensaje: messageTo\r\n            }\r\n        });\r\n\r\n        return NextResponse.json({ success: true });\r\n    } catch (error) {\r\n        console.error('Error sending message:', error);\r\n        return NextResponse.json({ error: 'Error sending message' }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}