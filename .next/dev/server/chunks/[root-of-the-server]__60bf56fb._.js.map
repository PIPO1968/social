{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/social/src/app/api/friends/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const nick = searchParams.get('nick');\r\n        const action = searchParams.get('action');\r\n\r\n        if (!nick) {\r\n            return NextResponse.json({ error: 'Nick requerido' }, { status: 400 });\r\n        }\r\n\r\n        if (action === 'friends') {\r\n            // Get user\r\n            const user = await prisma.user.findUnique({ where: { nick } });\r\n            if (!user) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n\r\n            // Get friends from both directions\r\n            const friendsAsUser = await prisma.amigo.findMany({\r\n                where: { userId: user.id },\r\n                include: { amigo: true }\r\n            });\r\n            const friendsAsAmigo = await prisma.amigo.findMany({\r\n                where: { amigoId: user.id },\r\n                include: { user: true }\r\n            });\r\n\r\n            const allFriends = [\r\n                ...friendsAsUser.map(f => f.amigo),\r\n                ...friendsAsAmigo.map(f => f.user)\r\n            ];\r\n\r\n            // Remove duplicates\r\n            const uniqueFriends = allFriends.filter((friend, index, self) =>\r\n                index === self.findIndex(f => f.id === friend.id)\r\n            );\r\n\r\n            return NextResponse.json({ friends: uniqueFriends });\r\n        }\r\n\r\n        if (action === 'requests') {\r\n            // Get user\r\n            const user = await prisma.user.findUnique({ where: { nick } });\r\n            if (!user) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n\r\n            // Get pending requests\r\n            const requests = await prisma.solicitudAmistad.findMany({\r\n                where: { solicitadoId: user.id, estado: 'pendiente' },\r\n                include: { solicitante: true }\r\n            });\r\n            return NextResponse.json({ requests: requests.map(r => ({ id: r.id, solicitante: r.solicitante })) });\r\n        }\r\n\r\n        return NextResponse.json({ error: 'Acci칩n no v치lida' }, { status: 400 });\r\n    } catch (error) {\r\n        console.error('Error en friends GET:', error);\r\n        return NextResponse.json({ error: 'Error interno del servidor' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const { action, userNick, friendNick, requestId } = await request.json();\r\n\r\n        let user = null;\r\n        let friend = null;\r\n\r\n        if (action === 'add' || action === 'remove') {\r\n            if (!userNick || !friendNick) {\r\n                return NextResponse.json({ error: 'Nicks requeridos' }, { status: 400 });\r\n            }\r\n\r\n            user = await prisma.user.findUnique({ where: { nick: userNick } });\r\n            friend = await prisma.user.findUnique({ where: { nick: friendNick } });\r\n\r\n            if (!user || !friend) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n        }\r\n\r\n        if (action === 'accept' || action === 'reject') {\r\n            if (!userNick || !requestId) {\r\n                return NextResponse.json({ error: 'Datos requeridos' }, { status: 400 });\r\n            }\r\n\r\n            user = await prisma.user.findUnique({ where: { nick: userNick } });\r\n            if (!user) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n        }\r\n\r\n        if (action === 'add') {\r\n            // Ensure user and friend are not null\r\n            if (!user || !friend) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n\r\n            // Check if already friends\r\n            const existingFriend = await prisma.amigo.findFirst({\r\n                where: {\r\n                    OR: [\r\n                        { userId: user.id, amigoId: friend.id },\r\n                        { userId: friend.id, amigoId: user.id }\r\n                    ]\r\n                }\r\n            });\r\n            if (existingFriend) {\r\n                return NextResponse.json({ error: 'Ya son amigos' }, { status: 400 });\r\n            }\r\n\r\n            // Check if request already exists (only pending)\r\n            const existingRequest = await prisma.solicitudAmistad.findFirst({\r\n                where: {\r\n                    OR: [\r\n                        { solicitanteId: user.id, solicitadoId: friend.id, estado: 'pendiente' },\r\n                        { solicitanteId: friend.id, solicitadoId: user.id, estado: 'pendiente' }\r\n                    ]\r\n                }\r\n            });\r\n            if (existingRequest) {\r\n                return NextResponse.json({ error: 'Solicitud ya existe' }, { status: 400 });\r\n            }\r\n\r\n            // Create request\r\n            await prisma.solicitudAmistad.create({\r\n                data: {\r\n                    solicitanteId: user.id,\r\n                    solicitadoId: friend.id\r\n                }\r\n            });\r\n            return NextResponse.json({ message: 'Solicitud enviada' });\r\n        }\r\n\r\n        if (action === 'accept') {\r\n            // Ensure user is not null\r\n            if (!user) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n\r\n            // Accept request\r\n            const solicitud = await prisma.solicitudAmistad.findUnique({\r\n                where: { id: requestId, solicitadoId: user.id, estado: 'pendiente' }\r\n            });\r\n            if (!solicitud) {\r\n                return NextResponse.json({ error: 'Solicitud no encontrada' }, { status: 404 });\r\n            }\r\n\r\n            // Update request\r\n            await prisma.solicitudAmistad.update({\r\n                where: { id: requestId },\r\n                data: { estado: 'aceptada' }\r\n            });\r\n\r\n            // Add friendship\r\n            await prisma.amigo.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    amigoId: solicitud.solicitanteId\r\n                }\r\n            });\r\n            await prisma.amigo.create({\r\n                data: {\r\n                    userId: solicitud.solicitanteId,\r\n                    amigoId: user.id\r\n                }\r\n            });\r\n            return NextResponse.json({ message: 'Amistad aceptada' });\r\n        }\r\n\r\n        if (action === 'reject') {\r\n            // Ensure user is not null\r\n            if (!user) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n\r\n            // Reject request\r\n            await prisma.solicitudAmistad.update({\r\n                where: { id: requestId, solicitadoId: user.id },\r\n                data: { estado: 'rechazada' }\r\n            });\r\n            return NextResponse.json({ message: 'Solicitud rechazada' });\r\n        }\r\n\r\n        if (action === 'remove') {\r\n            // Ensure user and friend are not null\r\n            if (!user || !friend) {\r\n                return NextResponse.json({ error: 'Usuario no encontrado' }, { status: 404 });\r\n            }\r\n\r\n            // Remove friend\r\n            await prisma.amigo.deleteMany({\r\n                where: {\r\n                    OR: [\r\n                        { userId: user.id, amigoId: friend.id },\r\n                        { userId: friend.id, amigoId: user.id }\r\n                    ]\r\n                }\r\n            });\r\n\r\n            // Also remove the accepted request\r\n            await prisma.solicitudAmistad.deleteMany({\r\n                where: {\r\n                    OR: [\r\n                        { solicitanteId: user.id, solicitadoId: friend.id, estado: 'aceptada' },\r\n                        { solicitanteId: friend.id, solicitadoId: user.id, estado: 'aceptada' }\r\n                    ]\r\n                }\r\n            });\r\n\r\n            return NextResponse.json({ message: 'Amigo removido' });\r\n        }\r\n\r\n        return NextResponse.json({ error: 'Acci칩n no v치lida' }, { status: 400 });\r\n    } catch (error) {\r\n        console.error('Error en friends POST:', error);\r\n        return NextResponse.json({ error: 'Error interno del servidor' }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}